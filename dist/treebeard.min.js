!function(t,e){"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?module.exports=e():t.Treebeard=e()}(this,function(){function t(){return i++}function e(t){return function(e,o){var n=e.data[t].toLowerCase().replace(/\s+/g," "),i=o.data[t].toLowerCase().replace(/\s+/g," ");return i>n?-1:n>i?1:0}}function o(t){return function(e,o){var n=e.data[t].toLowerCase().replace(/\s/g,""),i=o.data[t].toLowerCase().replace(/\s/g,"");return n>i?-1:i>n?1:0}}function n(t,e,o){for(var n=t.length;n--;)if(t[n]&&t[n].hasOwnProperty(e)&&arguments.length>2&&t[n][e]===o)return t.splice(n,1),!0;return!1}var i=0,a={},r=function(e){void 0===e?(this.data={},this.id=t()):(this.data=e,this.id=e.id||t()),this.depth=null,this.children=[],this.parentID=null,this.kind=null};r.prototype.add=function(t){return t.parentID=this.id,t.depth=this.depth+1,this.children.push(t),this.open=!0,this},r.prototype.move=function(t){var e=a[t],o=this.parentID,n=a[o];e.add(this),o>-1&&n.remove_child(parseInt(this.id))},r.prototype.remove_self=function(){{var t=this.parentID;n(t.children,"id",this.id)}return this},r.prototype.remove_child=function(t){n(this.children,"id",t);return this},r.prototype.next=function(){var t,e;e=a[this.parentID];for(var o=0;o<e.children.length;o++)e.children[o].id===this.id&&(t=e.children[o+1]);return t},r.prototype.prev=function(){var t,e;e=a[this.parentID];for(var o=0;o<e.children.length;o++)e.children[o].id===this.id&&(t=e.children[o-1]);return t},r.prototype.child=function(t){for(var e,o=0;o<this.children.length;o++)this.children[o].id===t&&(e=this.children[o]);return e},r.prototype.parent=function(){return a[this.parentID]},r.prototype.sort_children=function(t,n){"asc"===t&&this.children.sort(e(n)),"desc"===t&&this.children.sort(o(n))};var l={};return l.model=function(){return{id:Math.floor(1e4*Math.random()),load:!0,status:!0,show:!0,loadUrl:"small.json",person:"JohnnyB. Goode",name:"Around the World in 80 Days",date:"Date",filtered:!1,kind:"file",children:[]}},l.controller=function(){var t=this;this.flatData=[],this.treeData={},this.filterText=m.prop(""),this.showRange=[],this.filterOn=!1,this.sort={asc:!1,desc:!1,column:""},this.options=l.options,this.rangeMargin=0,this.detailItem={},this.visibleCache=0,this.visibleIndexes=[],this.visibleTop=[],this.lastLocation=0,this.lastNonFilterLocation=0,this.currentPage=m.prop(1),this.dropzone=null,this.droppedItem={},this.check={move:!0,"delete":!0,add:!0},this.buildTree=function(e,o){var n,i,a,l;if(Array.isArray(e)?(n=new r,i=e):(n=new r(e),i="undefined"!=typeof e.data?e.data[0].children:e.children,n.depth=n.depth?o.depth+1:0,n.kind=e.kind),i){a=i.length;for(var s=0;a>s;s++)l=t.buildTree(i[s],n),n.add(l)}return n},this.flatten=function(e,o){t.flatData=[];var n=1,i=function r(e,i,l){for(var s=e.length,d=0;s>d;d++){n&&e[d].depth<=n&&(i=!0);for(var c=e[d].children,h=[],p={id:e[d].id,depth:e[d].depth,row:e[d].data},u=0;u<e[d].children.length;u++)h.push(e[d].children[u].id);p.row.children=h,p.row.show=i,e[d].children.length>0&&!e[d].data.open&&(i=!1,n>e[d].depth&&(n=e[d].depth)),t.flatData.push(p),c.length>0&&r(c,i,!1),a[e[d].id]=e[d],l&&d===s-1&&(t.calculate_visible(o),t.calculate_height(),m.redraw())}};return i(e,!0,!0),e},this.init=function(e,o){if(!o){var n=$("#tb-tbody").height();t.options.showTotal=Math.floor(n/t.options.rowHeight),$("#tb-tbody").scroll(function(){var e=$(this).scrollTop(),o=e-t.lastLocation;o>0&&o<t.options.rowHeight&&$(this).scrollTop(t.lastLocation+t.options.rowHeight),0>o&&o>-t.options.rowHeight&&$(this).scrollTop(t.lastLocation-t.options.rowHeight);var n=t.calculate_height(),i=$(this).children(".tb-tbody-inner").outerHeight();e=$(this).scrollTop();var a=e/i*100,r=Math.round(a/100*t.visibleCache);t.rangeMargin=Math.round(n*(e/i)),t.refresh_range(r),m.redraw(!0),t.lastLocation=e}),$(".td-title").draggable({helper:"clone"}),$(".tb-row").droppable({tolerance:"touch",cursor:"move",out:function(){$(".tb-row.tb-h-success").removeClass("tb-h-success"),$(".tb-row.tb-h-error").removeClass("tb-h-error")},over:function(e,o){var n=$(this).attr("data-id"),i=o.draggable.attr("data-id"),r=a[n],l=a[i];$(this).addClass(n!==i&&t.options.movecheck(r,l)?"tb-h-success":"tb-h-error")},drop:function(e,o){var n=$(this).attr("data-id"),i=o.draggable.attr("data-id"),r=a[n],l=a[i];n!==i&&(t.options.movecheck(r,l)?(l.move(n),t.flatten(t.treeData.children,t.visibleTop)):alert("You can't move your item here.")),t.options.onmove&&t.options.onmove(r,l)}}),t.options.uploads&&t.apply_dropzone()}},this.delete_node=function(e,o){var n=a[e];n.remove_child(o),t.options.ondelete&&t.options.ondelete.call(n),t.flatten(t.treeData.children,t.visibleTop)},this.add_node=function(e){var o=new l.model,n=new r(o),i=a[e];i.add(n),t.flatten(t.treeData.children,t.visibleTop)},this.find=function(t){return a[t]},this.return_index=function(e){for(var o=t.flatData.length,n=0;o>n;n++){var i=t.flatData[n];if(i.row.id===e)return n}},this.row_filter_result=function(e){var o=t.filterText().toLowerCase(),n=e.title.toLowerCase().indexOf(o);return n>-1?!0:!1},this.filter=function(e){m.withAttr("value",t.filterText)(e);var o=t.filterText().toLowerCase();if(0===o.length)t.filterOn=!1,t.calculate_visible(0),t.calculate_height(),m.redraw(!0),$("#tb-tbody").scrollTop(t.lastNonFilterLocation);else{t.filterOn||(t.filterOn=!0,t.lastNonFilterLocation=t.lastLocation);var n=t.visibleTop;t.visibleTop||(n=0),t.calculate_visible(n),t.calculate_height(),m.redraw(!0)}},this.toggle_folder=function(e,o){var n=t.flatData.length,i=a[t.flatData[o].id],r=t.flatData[o];if(t.options.lazyLoad&&"folder"===r.row.kind&&0===r.row.children.length)$.when(t.options.resolve_lazyload_url(i)).done(function(o){m.request({method:"GET",url:o}).then(function(e){var o,n;for(n=0;n<e.length;n++)o=t.buildTree(e[n],i),i.add(o);i.data.open=!0}).then(function(){t.flatten(t.treeData.children,e)})});else{for(var l=!1,s=r.depth,d=r.depth,c=o+1;n>c;c++){var h=t.flatData[c];if(h.depth<=d)break;l&&h.depth>s||(h.depth===s&&(l=!1),r.row.open?h.row.show=!1:(h.row.show=!0,h.row.open||(s=h.depth,l=!0)))}r.row.open=!r.row.open,t.calculate_visible(e),t.calculate_height(),m.redraw(!0)}t.options.ontogglefolder&&t.options.ontogglefolder.call(i)},this.set_detail_item=function(e){t.detailItem=t.flatData[e].row,m.redraw(!0)},this.ascToggle=function(){var e=$(this).attr("data-direction"),o=$(this).attr("data-field"),n=$(this).parent();if($(".asc-btn, .desc-btn").addClass("tb-sort-inactive"),t.sort.asc=!1,t.sort.desc=!1,!t.sort[e]){var i=0,a=function r(t){t.map(function(t){t.sort_children(e,o),t.children.length>0&&r(t.children),i++})};t.treeData.sort_children(e,o),a(t.treeData.children),n.children("."+e+"-btn").removeClass("tb-sort-inactive"),t.sort[e]=!0,t.flatten(t.treeData.children,0)}},this.calculate_height=function(){var e;if(t.paginate)e=t.options.showTotal*t.options.rowHeight,t.rangeMargin=0;else{var o=t.visibleCache;e=o*t.options.rowHeight}return $(".tb-tbody-inner").height(e),e},this.calculate_visible=function(e){e=e||0;var o=t.flatData.length,n=0;t.visibleIndexes=[];for(var i=0;o>i;i++){var a=t.flatData[i].row;t.filterOn?t.row_filter_result(a)&&(n++,t.visibleIndexes.push(i)):a.show&&(t.visibleIndexes.push(i),n++)}return t.visibleCache=n,t.refresh_range(e),n},this.refresh_range=function(e){var o=t.visibleCache,n=[],i=0;t.visibleTop=e;for(var a=e;o>a&&n.length!==t.options.showTotal;a++){var r=t.visibleIndexes[a];n.push(r),i++}t.showRange=n,m.redraw(!0)},this.toggle_scroll=function(){t.options.paginate=!1,$(".tb-paginate").removeClass("active"),$(".tb-scroll").addClass("active"),t.refresh_range(0)},this.toggle_paginate=function(){t.options.paginate=!0,$(".tb-scroll").removeClass("active"),$(".tb-paginate").addClass("active");var e=t.showRange[0],o=t.visibleIndexes.indexOf(e),n=Math.floor(o/t.options.showTotal),i=n*t.options.showTotal;t.currentPage(n+1),t.refresh_range(i)},this.page_up=function(){var e=t.showRange[t.options.showTotal-1],o=t.visibleIndexes.indexOf(e);o>-1&&o+1<t.visibleCache&&(t.refresh_range(o+1),t.currentPage(t.currentPage()+1))},this.page_down=function(){var e=t.showRange[0],o=t.visibleIndexes.indexOf(e);o&&o>0&&(t.refresh_range(o-t.options.showTotal),t.currentPage(t.currentPage()-1))},this.jump_to_page=function(e){var o=parseInt(e.target.value);if(o&&o>0&&o<=Math.ceil(t.visibleIndexes.length/t.options.showTotal)){m.withAttr("value",t.currentPage)(e);var n=parseInt(t.currentPage()),i=t.options.showTotal*(n-1);t.refresh_range(i)}},this.apply_dropzone=function(){t.dropzone&&t.destroy_dropzone();var e=["drop","dragstart","dragend","dragenter","dragover","dragleave","addedfile","removedfile","thumbnail","error","processing","uploadprogress","sending","success","complete","canceled","maxfilesreached","maxfilesexceeded"],o=$.extend({init:function(){for(var o=0;o<e.length;o++){var n=e[o];t.options.dropzone[n]&&this.on(n,function(e){t.options.dropzone[n].call(t,e)})}},accept:function(e,o){t.options.addcheck(t.droppedItem,e)?$.when(t.options.resolve_upload_url(t.droppedItem)).then(function(e){return e&&(t.dropzone.url=e),e}).done(function(){o()}):alert("This isn't allowed")},drop:function(e){var o=$(e.target).closest(".tb-row").attr("data-id"),n=a[o];t.droppedItem=n},addedfile:function(){},dragenter:function(){},success:function(){var e=new l.model,o=new r(e);t.droppedItem.add(o),t.flatten(t.treeData.children,t.visibleTop)},sending:function(){}},t.options.dropzone);t.dropzone=new Dropzone("#"+t.options.divID,o)},this.destroy_dropzone=function(){t.dropzone.destroy()},this.subFix=function(e){var o=a[e.id];return e.children.length>0||"folder"===e.kind?e.children.length>0&&e.open?[m("span.expand-icon-holder",m("i.fa.fa-minus-square-o"," ")),m("span.expand-icon-holder",t.options.resolve_icon(o))]:[m("span.expand-icon-holder",m("i.fa.fa-plus-square-o"," ")),m("span.expand-icon-holder",t.options.resolve_icon(o))]:[m("span.expand-icon-holder"),m("span.expand-icon-holder",t.options.resolve_icon(o))]},this.loadData=function(e){e instanceof Array?$.when(t.buildTree(e)).then(function(e){return t.treeData=e,a[0]=e,t.flatten(t.treeData.children),e}).done(function(){t.calculate_visible(),t.calculate_height()}):this.data=m.request({method:"GET",url:e}).then(function(e){t.treeData=t.buildTree(e)}).then(function(){a[0]=t.treeData,t.flatten(t.treeData.children)}).then(function(){t.calculate_visible(),t.calculate_height()})},this.data=t.loadData(l.options.filesData)},l.view=function(t){return console.log(t.showRange),[m(".gridWrapper.row",{config:t.init},[m(".col-sm-8",[m(".tb-table",[m(".tb-head",[m(".row",[m(".col-xs-8",[m("input.form-control[placeholder='filter'][type='text']",{style:"width:300px;display:inline; margin-right:20px;",onkeyup:t.filter,value:t.filterText()}),m("span",{style:"width: 120px"},"Visible : "+t.visibleCache)])])]),m(".tb-row-titles.m-t-md",[t.options.columns.map(function(e){var o="";return e.sort&&(o=[m("i.fa.fa-sort-asc.tb-sort-inactive.asc-btn",{onclick:t.ascToggle,"data-direction":"asc","data-field":e.data}),m("i.fa.fa-sort-desc.tb-sort-inactive.desc-btn",{onclick:t.ascToggle,"data-direction":"desc","data-field":e.data})]),m(".tb-th",{style:"width: "+e.width},[m("span.padder-10",e.title),o])})]),m("#tb-tbody",[m(".tb-tbody-inner",[m("",{style:"padding-left: 15px;margin-top:"+t.rangeMargin+"px"},[t.showRange.map(function(e,o){var n,i,r=t.flatData[e].depth,l=t.flatData[e].id,s=t.flatData[e].row;return n=t.filterOn?0:20*r,i=l===t.detailItem.id?"tb-row-active":"",m(".tb-row",{"class":i,"data-id":l,"data-level":r,"data-index":e,"data-rIndex":o,style:"height: "+t.options.rowHeight+"px;",onclick:function(){t.set_detail_item(e),t.options.onselectrow&&t.options.onselectrow.call(a[s.id])}},[t.options.columns.map(function(o){var i;return i=m(".tb-td",{style:"width:"+o.width},[m("span",s[o.data])]),o.folderIcons===!0&&(i=m(".tb-td.td-title",{"data-id":l,style:"padding-left: "+n+"px; width:"+o.width},[m("span.tdFirst",{onclick:function(){t.toggle_folder(t.visibleTop,e)}},t.subFix(s)),m("span.title-text",s[o.data]+" ")])),o.actionIcons===!0&&(i=m(".tb-td",{style:"width:"+o.width},[m("button.btn.btn-danger.btn-xs",{"data-id":l,onclick:function(){t.delete_node(s.parent,l)}}," X "),m("button.btn.btn-success.btn-xs",{"data-id":l,onclick:function(){t.add_node(l)}}," Add "),m("button.btn.btn-info.btn-xs",{"data-id":l,onclick:function(){var t='.tb-row[data-id="'+l+'"]';$(t).css("font-weight","bold")}},"?")])),o.custom&&(i=m(".tb-td",{style:"width:"+o.width},[o.custom.call(s,o)])),i})])})])])]),function(){return t.options.paginate||t.options.paginateToggle?m(".tb-footer",[m(".row",[m(".col-xs-4",function(){return t.options.paginateToggle?m(".btn-group.padder-10",[m("button.btn.btn-default.btn-sm.active.tb-scroll",{onclick:t.toggle_scroll},"Scroll"),m("button.btn.btn-default.btn-sm.tb-paginate",{onclick:t.toggle_paginate},"Paginate")]):void 0}()),m(".col-xs-8",[m(".padder-10",[function(){return t.options.paginate?m(".pull-right",[m("button.btn.btn-default.btn-sm",{onclick:t.page_down},[m("i.fa.fa-chevron-left")]),m("input.h-mar-10",{type:"text",style:"width: 30px;",onkeyup:t.jump_to_page,value:t.currentPage()}),m("span","/ "+Math.ceil(t.visibleIndexes.length/t.options.showTotal)+" "),m("button.btn.btn-default.btn-sm",{onclick:t.page_up},[m("i.fa.fa-chevron-right")])]):void 0}()])])])]):void 0}()])]),m(".col-sm-4",[m(".tb-details",[m("h2",t.detailItem.title),m("h4.m-t-md",t.detailItem.person),m("p.m-t-md",t.detailItem.desc),m("i.m-t-md",t.detailItem.date)])])])]},l.run=function(t){l.options=$.extend({divID:"myGrid",filesData:"small.json",rowHeight:35,showTotal:15,paginate:!1,paginateToggle:!1,lazyLoad:!1,uploads:!0,columns:[],deletecheck:function(){},ondelete:function(){console.log("ondelete",this)},movecheck:function(t,e){return console.log("movecheck: to",t,"from",e),!0},onmove:function(t,e){console.log("onmove: to",t,"from",e)},addcheck:function(){return!0},onadd:function(){},onselectrow:function(){console.log("onselectrow",this)},ontogglefolder:function(){console.log("ontogglefolder",this)},dropzone:{url:"http://www.torrentplease.com/dropzone.php",dropend:function(){}},resolve_icon:function(t){return"folder"===t.kind?m("i.fa.fa-folder-o"," "):t.data.icon?m("i.fa."+t.icon," "):m("i.fa.fa-file ")},resolve_upload_url:function(){return"/upload"},resolve_lazyload_url:function(){return"small.json"}},t),m.module(document.getElementById(l.options.divID),l)},l});