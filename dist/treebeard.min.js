!function(t,e){"use strict";"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?module.exports=e():t.Treebeard=e()}(this,function(){"use strict";function t(){return d+=1}function e(t){return"[object Function]"===Object.prototype.toString.call(t)}function o(t){return t?e(t)?t():t:""}function n(t,e){return"number"===e?function(t,e){return t-e}:function(e,o){var n=e.data[t].toLowerCase().replace(/\s+/g," "),i=o.data[t].toLowerCase().replace(/\s+/g," ");return i>n?-1:n>i?1:0}}function i(t,e){return"number"===e?function(t,e){return e-t}:function(e,o){var n=e.data[t].toLowerCase().replace(/\s/g,""),i=o.data[t].toLowerCase().replace(/\s/g,"");return n>i?-1:i>n?1:0}}function r(t,e,o){var n;for(n=0;n<t.length;n++)if(t[n]&&t[n].hasOwnProperty(e)&&arguments.length>2&&t[n][e]===o)return t.splice(n,1),!0;return!1}var a,s={},l={},d=-1;return a=function(e){void 0===e?(this.data={},this.kind="folder",this.open=!0):(this.data=e,this.kind=e.kind||"item",this.open=e.open),this.id=t(),this.depth=0,this.children=[],this.parentID=null},a.prototype.add=function(t){return t.parentID=this.id,t.depth=this.depth+1,this.children.push(t),this},a.prototype.move=function(t){var e=s[t],o=this.parentID,n=s[o];e.add(this),e.redoDepth(),o>-1&&n.removeChild(parseInt(this.id,10))},a.prototype.redoDepth=function(){function t(o,n){for(e=0;e<o.length;e++)o[e].depth=n,o[e].children.length>0&&t(o[e].children,n+1)}var e;t(this.children,this.depth+1)},a.prototype.removeSelf=function(){var t=this.parent();return t.removeChild(this.id),this},a.prototype.removeChild=function(t){return r(this.children,"id",t),this},a.prototype.next=function(){var t,e,o;for(e=s[this.parentID],o=0;o<e.children.length;o++)if(e.children[o].id===this.id)return t=e.children[o+1];if(!t)throw new Error("Treebeard Error: Item with ID '"+this.id+"' has no next sibling")},a.prototype.prev=function(){var t,e,o;for(e=s[this.parentID],o=0;o<e.children.length;o++)if(e.children[o].id===this.id)return t=e.children[o-1];if(!t)throw new Error("Treebeard Error: Item with ID '"+this.id+"' has no previous sibling")},a.prototype.child=function(t){var e,o;for(o=0;o<this.children.length;o++)if(this.children[o].id===t)return e=this.children[o];if(!e)throw new Error("Treebeard Error: Parent with ID '"+this.id+"' has no child with ID: "+t)},a.prototype.parent=function(){return s[this.parentID]?s[this.parentID]:void 0},a.prototype.sortChildren=function(t,e,o){if(!t||!e)throw new Error("Treebeard Error: To sort children you need to pass both direction and field to Item.sortChildren");this.children.length>0&&("asc"===t&&this.children.sort(n(e,o)),"desc"===t&&this.children.sort(i(e,o)))},a.prototype.isAncestor=function(t){function e(t,o){return t.id===o.id?!0:t.parent()?e(t.parent(),o):!1}return e(t.parent(),this)},a.prototype.isDescendant=function(t){function e(t,i){for(o=0;o<t.length;o++){if(t[o].id===i.id){n=!0;break}if(t[o].children.length>0)return e(t[o].children,i)}return n}var o,n=!1;return e(t.children,this)},l.controller=function(){function t(){$(".td-title").draggable({helper:"clone",delay:300,drag:function(t,e){$(e.helper).css({height:"25px",width:"400px",background:"white",padding:"0px 10px","box-shadow":"0 0 4px #ccc"})}}),$(".tb-row").droppable({tolerance:"fit",cursor:"move",out:function(){$(".tb-row.tb-h-success").removeClass("tb-h-success"),$(".tb-row.tb-h-error").removeClass("tb-h-error")},over:function(t,e){var o,n,i,r;o=$(this).attr("data-id"),n=e.draggable.attr("data-id"),i=s[o],r=s[n],$(this).addClass(o!==n&&c.options.movecheck(i,r)&&c.canMove(i,r)?"tb-h-success":"tb-h-error")},drop:function(t,e){var o,n,i,r;o=$(this).attr("data-id"),n=e.draggable.attr("data-id"),i=s[o],r=s[n],o!==n&&(c.options.movecheck.call(c,i,r)&&c.canMove(i,r)?(r.move(o),c.flatten(c.treeData.children,c.visibleTop),c.options.onmove&&c.options.onmove(i,r)):c.options.movefail?c.options.movefail.call(c,i,r):window.alert("You can't move your item here.")),$(".tb-row.tb-h-success").removeClass("tb-h-success"),$(".tb-row.tb-h-error").removeClass("tb-h-error")}})}function e(t){$("#tb-tbody").scrollTop(0),c.currentPage(1);var e,o,n=c.filterText().toLowerCase(),i=!1;for(e=0;e<c.options.columns.length;e++)o=c.options.columns[e],o.filter&&-1!==t[o.data].toLowerCase().indexOf(n)&&(i=!0);return i}function o(){var t;return c.options.paginate?(t=c.options.showTotal*c.options.rowHeight,c.rangeMargin=0):t=c.visibleIndexes.length*c.options.rowHeight,$(".tb-tbody-inner").height(t),t}function n(t){t=t||0;var o,n,i=c.flatData.length,r=0;for(c.visibleIndexes=[],o=0;i>o;o++)n=c.flatData[o].row,c.filterOn?e(n)&&(r++,c.visibleIndexes.push(o)):c.flatData[o].show&&(c.visibleIndexes.push(o),r+=1);return c.refreshRange(t),r}function i(){c.dropzone.destroy()}function r(){c.dropzone&&i();var t=["drop","dragstart","dragend","dragenter","dragover","dragleave","addedfile","removedfile","thumbnail","error","processing","uploadprogress","sending","success","complete","canceled","maxfilesreached","maxfilesexceeded"],e=$.extend({init:function(){var e,o,n;for(n=0;n<t.length;n++)e=t[n],c.options.dropzone[e]&&(o=this,this.on(e,function(t){c.options.dropzone[e].call(o,c,t)}))},clickable:!1,accept:function(t,e){c.options.addcheck.call(this,c,c.droppedItemCache,t)?$.when(c.options.resolveUploadUrl.call(c,c.droppedItemCache)).then(function(t){return t&&(c.dropzone.options.url=t),t}).done(function(){e()}):window.alert("This isn't allowed")},drop:function(t){var e=$(t.target).closest(".tb-row").attr("data-id"),o=s[e];c.droppedItemCache=o},success:function(t,e){var o=new a;c.droppedItemCache.add(o),c.flatten(c.treeData.children,c.visibleTop),c.options.onadd&&c.options.onadd.call(this,c,c.droppedItemCache,t,e)}},c.options.dropzone);c.dropzone=new Dropzone("#"+c.options.divID,e)}function d(t){if($.isArray(t))$.when(c.buildTree(t)).then(function(t){return c.treeData=t,s[0]=t,c.flatten(c.treeData.children),t}).done(function(){n(),o()});else{var e=new RegExp("(http|ftp|https)://[w-]+(.[w-]*)+([w.,@?^=%&amp;:/~+#-]*[w@?^=%&amp;/~+#-])?");if(-1===c.options.filesData.indexOf("localhost")&&!e.test(c.options.filesData))throw new Error("Treebeard Error: Your URL is not valid. Include full path. You provided: "+c.options.filesData);m.request({method:"GET",url:t}).then(function(t){c.treeData=c.buildTree(t)}).then(function(){s[0]=c.treeData,c.flatten(c.treeData.children)}).then(function(){n(),o()})}}var c=this,h={asc:!1,desc:!1,column:""},p=0,f=0;if(this.flatData=[],this.treeData={},this.filterText=m.prop(""),this.showRange=[],this.options=l.options,this.selected=void 0,this.rangeMargin=0,this.visibleIndexes=[],this.visibleTop=void 0,this.currentPage=m.prop(1),this.dropzone=null,this.droppedItemCache=void 0,this.filterOn=!1,this.redraw=function(){c.flatten(c.treeData.children,c.visibleTop)},this.deleteNode=function(t,e){var o=s[e],n=$.extend({},o);$.when(c.options.deletecheck.call(c,o)).done(function(o){if(o){var i=s[t];i.removeChild(e),c.flatten(c.treeData.children,c.visibleTop),c.options.ondelete&&c.options.ondelete.call(c,n)}})},this.canMove=function(t,e){return"folder"!==t.kind?!1:t.isDescendant(e)?!1:!0},this.createItem=function(t,e){var o=s[e];$.when(c.options.createcheck.call(c,t,o)).done(function(e){if(!e)throw new Error("Treebeard Error: createcheck function returned false, item not created.");var n=new a(t);o.add(n),c.flatten(c.treeData.children,c.visibleTop),c.options.oncreate&&c.options.oncreate.call(c,n,o)})},this.find=function(t){return s[t]},this.returnIndex=function(t){var e,o,n=c.flatData.length;for(e=0;n>e;e++)if(o=c.flatData[e],o.row.id===t)return e},this.filter=function(t){m.withAttr("value",c.filterText)(t);var e=c.filterText().toLowerCase(),i=c.visibleTop;0===e.length?(c.filterOn=!1,n(0),o(),m.redraw(!0),$("#tb-tbody").scrollTop(f),c.options.onfilterreset&&c.options.onfilterreset.call(c,e)):(c.filterOn||(c.filterOn=!0,f=p),c.visibleTop||(i=0),n(i),o(),m.redraw(!0),c.options.onfilter&&c.options.onfilter.call(c,e))},this.toggleFolder=function(e,i){var r,a,l,d,h,p=c.flatData.length,f=s[c.flatData[e].id],u=c.flatData[e],g=!1,w=u.depth,v=u.depth;if(c.options.resolveLazyloadUrl&&"folder"===u.row.kind&&0===u.row.children.length)$.when(c.options.resolveLazyloadUrl(c,f)).done(function(t){m.request({method:"GET",url:t}).then(function(t){for(a=0;a<t.length;a++)r=c.buildTree(t[a],f),f.add(r);f.open=!0}).then(function(){c.flatten(c.treeData.children,topIndex)})});else{for(l=e+1;p>l&&(d=c.flatData[l],h=s[c.flatData[l].id],!(d.depth<=v));l++)g&&d.depth>w||(d.depth===w&&(g=!1),f.open?d.show=!1:(d.show=!0,h.open||(w=d.depth,g=!0)));f.open=!f.open,n(c.visibleTop),o(),m.redraw(!0)}t(),c.options.ontogglefolder&&c.options.ontogglefolder.call(c,f,i)},this.sortToggle=function(){var t,e=$(this).attr("data-direction"),o=$(this).attr("data-field"),n=$(this).attr("data-sortType"),i=$(this).parent(),r=0;$(".asc-btn, .desc-btn").addClass("tb-sort-inactive"),h.asc=!1,h.desc=!1,h[e]||(t=function(i){i.map(function(i){i.sortChildren(e,o,n),i.children.length>0&&t(i.children),r+=1})},c.treeData.sortChildren(e,o,n),t(c.treeData.children),i.children("."+e+"-btn").removeClass("tb-sort-inactive"),h[e]=!0,c.flatten(c.treeData.children,0))},this.refreshRange=function(t){var e,o,n=c.visibleIndexes.length,i=[],r=0;for(c.visibleTop=t,e=t;n>e&&i.length!==c.options.showTotal;e++)o=c.visibleIndexes[e],i.push(o),r+=1;c.showRange=i,m.redraw.strategy("none"),m.redraw(!0)},this.toggleScroll=function(){c.options.paginate=!1,$(".tb-paginate").removeClass("active"),$(".tb-scroll").addClass("active"),$("#tb-tbody").scrollTop((c.currentPage()-1)*c.options.showTotal*c.options.rowHeight),o()},this.togglePaginate=function(){var t=c.showRange[0],e=c.visibleIndexes.indexOf(t),n=Math.floor(e/c.options.showTotal),i=n*c.options.showTotal;c.options.paginate=!0,$(".tb-scroll").removeClass("active"),$(".tb-paginate").addClass("active"),c.currentPage(n+1),o(),c.refreshRange(i)},this.pageUp=function(){var t=c.showRange[c.options.showTotal-1],e=c.visibleIndexes.indexOf(t);e>-1&&e+1<c.visibleIndexes.length&&(c.refreshRange(e+1),c.currentPage(c.currentPage()+1))},this.pageDown=function(){var t=c.showRange[0],e=c.visibleIndexes.indexOf(t);e&&e>0&&(c.refreshRange(e-c.options.showTotal),c.currentPage(c.currentPage()-1))},this.goToPage=function(t){if(t&&t>0&&t<=Math.ceil(c.visibleIndexes.length/c.options.showTotal)){var e=c.options.showTotal*(t-1);c.currentPage(t),c.refreshRange(e)}},this.buildTree=function(t,e){var o,n,i,r,s;if(Array.isArray(t)?(o=new a,n=t):(o=new a(t),n=t.children,o.depth=e.depth+1),n)for(i=n.length,s=0;i>s;s++)r=c.buildTree(n[s],o),o.add(r);return o},this.flatten=function(t,e){c.flatData=[];var i=1,r=function a(t,r,l){var d,h,p,f=t.length;for(d=0;f>d;d++)i&&t[d].depth<=i&&(r=!0),h=t[d].children,p={id:t[d].id,depth:t[d].depth,row:t[d].data},p.show=r,t[d].children.length>0&&!t[d].open&&(r=!1,i>t[d].depth&&(i=t[d].depth)),c.flatData.push(p),h.length>0&&a(h,r,!1),s[t[d].id]=t[d],l&&d===f-1&&(n(e),o(),m.redraw())};return r(t,!0,!0),t},this.init=function(e,n){if(!n){var i=$("#tb-tbody").height();c.options.showTotal=Math.floor(i/c.options.rowHeight),c.options.rowHeight||(c.options.rowHeight=$(".tb-row").height()),$("#tb-tbody").scroll(function(){if(!c.options.paginate){var t,e,n,i,r,a;t=$(this).scrollTop(),e=t-p,e>0&&e<c.options.rowHeight&&$(this).scrollTop(p+c.options.rowHeight),0>e&&e>-c.options.rowHeight&&$(this).scrollTop(p-c.options.rowHeight),n=o(),i=$(this).children(".tb-tbody-inner").outerHeight(),t=$(this).scrollTop(),r=t/i*100,a=Math.round(r/100*c.visibleIndexes.length),c.rangeMargin=Math.round(n*(t/i)),c.refreshRange(a),m.redraw(!0),p=t}}),c.options.allowMove&&t(),c.options.uploads&&r()}},!c.options.filesData)throw new Error("Treebeard Error: You need to define a data source through 'options.filesData'");d(c.options.filesData)},l.view=function(t){return[m(".gridWrapper",{config:t.init},[m(".tb-table",[function(){return t.options.showFilter||t.options.title?m(".tb-head",[m(".tb-head-title",[m("h3",o(t.options.title))]),m(".tb-head-filter",[function(){return t.options.showFilter?m("input.form-control[placeholder='filter'][type='text']",{style:"width:100%;display:inline;",onkeyup:t.filter,value:t.filterText()}):void 0}()])]):void 0}(),m(".tb-row-titles",[t.options.columns.map(function(e){var o="";return e.sort&&(o=[m("i.fa.fa-sort-asc.tb-sort-inactive.asc-btn.m-r-xs",{onclick:t.sortToggle,"data-direction":"asc","data-field":e.data,"data-sortType":e.sortType}),m("i.fa.fa-sort-desc.tb-sort-inactive.desc-btn",{onclick:t.sortToggle,"data-direction":"desc","data-field":e.data,"data-sortType":e.sortType})]),m(".tb-th",{style:"width: "+e.width},[m("span.padder-10.m-r-sm",e.title),o])})]),m("#tb-tbody",[m(".tb-tbody-inner",[m("",{style:"margin-top:"+t.rangeMargin+"px"},[t.showRange.map(function(e,o){var n,i,r="tb-odd",a=t.flatData[e].depth,l=t.flatData[e].id,d=s[l],c=t.flatData[e].row;return o%2===0&&(r="tb-even"),n=t.filterOn?0:20*a,i=l===t.selected?"tb-row-active":"",m(".tb-row",{"class":i+" "+r,"data-id":l,"data-level":a,"data-index":e,"data-rIndex":o,style:"height: "+t.options.rowHeight+"px;",onclick:function(e){t.selected=l,t.options.onselectrow&&t.options.onselectrow.call(t,d,e)}},[t.options.columns.map(function(o){var i;return i=m(".tb-td",{style:"width:"+o.width},[m("span",c[o.data])]),o.folderIcons===!0&&(i=m(".tb-td.td-title",{"data-id":l,style:"padding-left: "+n+"px; width:"+o.width},[m("span.tdFirst",{onclick:function(o){t.toggleFolder(e,o)}},function(){var e=m("span.tb-expand-icon-holder",t.options.resolveIcon.call(t,d)),o=m("span.tb-expand-icon-holder",t.options.resolveToggle.call(t,d));return t.filterOn?e:[o,e]}()),m("span.title-text",c[o.data]+" ")])),o.custom&&(i=m(".tb-td",{style:"width:"+o.width},[o.custom.call(t,d,o)])),i})])})])])]),function(){return t.options.paginate||t.options.paginateToggle?m(".tb-footer",[m(".row",[m(".col-xs-4",function(){if(t.options.paginateToggle){var e="",o="";return t.options.paginate?o="active":e="active",m(".btn-group.padder-10",[m("button.btn.btn-default.btn-sm.tb-scroll",{onclick:t.toggleScroll,"class":e},"Scroll"),m("button.btn.btn-default.btn-sm.tb-paginate",{onclick:t.togglePaginate,"class":o},"Paginate")])}}()),m(".col-xs-8",[m(".padder-10",[function(){if(t.options.paginate){var e=t.visibleIndexes.length,o=Math.ceil(e/t.options.showTotal);return m(".pull-right",[m("button.btn.btn-default.btn-sm.m-r-sm",{onclick:t.pageDown},[m("i.fa.fa-chevron-left")]),m("input.m-r-sm",{type:"text",style:"width: 30px;",onkeyup:function(e){var o=parseInt(e.target.value,10);t.goToPage(o)},value:t.currentPage()}),m("span","/ "+o+" "),m("button.btn.btn-default.btn-sm",{onclick:t.pageUp},[m("i.fa.fa-chevron-right")])])}}()])])])]):void 0}()])])]},l.run=function(t){l.options=$.extend({divID:"myGrid",filesData:"small.json",rowHeight:void 0,showTotal:15,paginate:!1,paginateToggle:!1,uploads:!0,columns:[{title:"Title",width:"50%",data:"title",sort:!0,sortType:"text",folderIcons:!0}],showFilter:!0,title:"Grid Title",allowMove:!0,onfilter:function(t){window.console.log("on filter: this",this,"filterText",t)},onfilterreset:function(t){window.console.log("on filter reset: this",this,"filterText",t)},createcheck:function(t,e){return window.console.log("createcheck",this,t,e),!0},oncreate:function(t,e){window.console.log("oncreate",this,t,e)},deletecheck:function(t){return window.console.log("deletecheck",this,t),!0},ondelete:function(){window.console.log("ondelete",this)},movecheck:function(t,e){return window.console.log("movecheck: to",t,"from",e),!0},onmove:function(t,e){window.console.log("onmove: to",t,"from",e)},movefail:function(t,e){return window.console.log("moovefail: to",t,"from",e),!0},addcheck:function(t,e,o){return window.console.log("Add check",this,t,e,o),!0},onadd:function(t,e,o,n){window.console.log("On add",this,t,e,o,n)},onselectrow:function(t,e){window.console.log("onselectrow",this,t,e)},ontogglefolder:function(t,e){window.console.log("ontogglefolder",this,t,e)},dropzone:{url:"http://www.torrentplease.com/dropzone.php",dragstart:function(t,e){window.console.log("dragstart",this,t,e)}},resolveIcon:function(t){return"folder"===t.kind?t.open?m("i.fa.fa-folder-open-o"," "):m("i.fa.fa-folder-o"," "):t.data.icon?m("i.fa."+t.data.icon," "):m("i.fa.fa-file ")},resolveToggle:function(t){var e=m("i.fa.fa-minus-square-o"," "),o=m("i.fa.fa-plus-square-o"," ");return"folder"===t.kind&&t.children.length>0?t.open?e:o:""},resolveUploadUrl:function(t){return window.console.log("resolveUploadUrl",this,t),"/upload"},resolveLazyloadUrl:function(t){return window.console.log("resolveLazyloadUrl",this,t),"small.json"}},t),m.module(document.getElementById(l.options.divID),l)},l});