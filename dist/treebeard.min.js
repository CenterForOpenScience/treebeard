!function(t,e){"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?module.exports=e():t.Treebeard=e()}(this,function(){function t(){return a++}function e(t){return"[object Function]"===Object.prototype.toString.call(t)}function o(t){return t?e(t)?t():t:""}function n(t){return function(e,o){var n=e.data[t].toLowerCase().replace(/\s+/g," "),i=o.data[t].toLowerCase().replace(/\s+/g," ");return i>n?-1:n>i?1:0}}function i(t){return function(e,o){var n=e.data[t].toLowerCase().replace(/\s/g,""),i=o.data[t].toLowerCase().replace(/\s/g,"");return n>i?-1:i>n?1:0}}function r(t,e,o){for(var n=t.length;n--;)if(t[n]&&t[n].hasOwnProperty(e)&&arguments.length>2&&t[n][e]===o)return t.splice(n,1),!0;return!1}var a=0,l={},s=function(e){void 0===e?(this.data={},this.id=t()):(this.data=e,this.id=e.id||t()),this.depth=0,this.children=[],this.parentID=null,this.kind=null};s.prototype.add=function(t){return t.parentID=this.id,t.depth=this.depth+1,this.children.push(t),this.open=!0,this},s.prototype.move=function(t){var e=l[t],o=this.parentID,n=l[o];e.add(this),o>-1&&n.remove_child(parseInt(this.id))},s.prototype.remove_self=function(){{var t=this.parent();r(t.children,"id",this.id)}return this},s.prototype.remove_child=function(t){r(this.children,"id",t);return this},s.prototype.next=function(){var t,e;e=l[this.parentID];for(var o=0;o<e.children.length;o++)e.children[o].id===this.id&&(t=e.children[o+1]);return t},s.prototype.prev=function(){var t,e;e=l[this.parentID];for(var o=0;o<e.children.length;o++)e.children[o].id===this.id&&(t=e.children[o-1]);return t},s.prototype.child=function(t){for(var e,o=0;o<this.children.length;o++)this.children[o].id===t&&(e=this.children[o]);return e},s.prototype.parent=function(){return l[this.parentID]},s.prototype.sort_children=function(t,e){"asc"===t&&this.children.sort(n(e)),"desc"===t&&this.children.sort(i(e))};var d={};return d.model=function(){return{id:Math.floor(1e4*Math.random()),load:!0,status:!0,show:!0,loadUrl:"small.json",person:"JohnnyB. Goode",name:"Around the World in 80 Days",date:"Date",filtered:!1,kind:"file",children:[]}},d.controller=function(){function t(){$(".td-title").draggable({helper:"clone"}),$(".tb-row").droppable({tolerance:"touch",cursor:"move",out:function(){$(".tb-row.tb-h-success").removeClass("tb-h-success"),$(".tb-row.tb-h-error").removeClass("tb-h-error")},over:function(t,e){var o=$(this).attr("data-id"),n=e.draggable.attr("data-id"),i=l[o],r=l[n];$(this).addClass(o!==n&&c.options.movecheck(i,r)?"tb-h-success":"tb-h-error")},drop:function(t,e){var o=$(this).attr("data-id"),n=e.draggable.attr("data-id"),i=l[o],r=l[n];o!==n&&(c.options.movecheck.call(c,i,r)?(r.move(o),c.flatten(c.treeData.children,c.visibleTop),c.options.onmove&&c.options.onmove(i,r)):alert("You can't move your item here."))}})}function e(t){var e=c.filterText().toLowerCase(),o=t.title.toLowerCase().indexOf(e);return o>-1?!0:!1}function o(){var t;if(c.paginate)t=c.options.showTotal*c.options.rowHeight,c.rangeMargin=0;else{var e=c.visibleCache;t=e*c.options.rowHeight}return $(".tb-tbody-inner").height(t),t}function n(t){t=t||0;var o=c.flatData.length,n=0;c.visibleIndexes=[];for(var i=0;o>i;i++){var r=c.flatData[i].row;c.filterOn?e(r)&&(n++,c.visibleIndexes.push(i)):r.show&&(c.visibleIndexes.push(i),n++)}return c.visibleCache=n,c.refresh_range(t),n}function i(){c.dropzone&&r();var t=["drop","dragstart","dragend","dragenter","dragover","dragleave","addedfile","removedfile","thumbnail","error","processing","uploadprogress","sending","success","complete","canceled","maxfilesreached","maxfilesexceeded"],e=$.extend({init:function(){for(var e=0;e<t.length;e++){var o=t[e];if(c.options.dropzone[o]){var n=this;this.on(o,function(t){c.options.dropzone[o].call(n,c,t)})}}},accept:function(t,e){console.log("Accept",this,c,t),c.options.addcheck.call(this,c,c.droppedItem,t)?$.when(c.options.resolve_upload_url.call(c,c.droppedItem)).then(function(t){return t&&(c.dropzone.url=t),t}).done(function(){e()}):alert("This isn't allowed")},drop:function(t){var e=$(t.target).closest(".tb-row").attr("data-id"),o=l[e];c.droppedItem=o},success:function(t,e){var o=new d.model,n=new s(o);c.droppedItem.add(n),c.flatten(c.treeData.children,c.visibleTop),c.options.onadd&&c.options.onadd.call(this,c,c.droppedItem,t,e)}},c.options.dropzone);c.dropzone=new Dropzone("#"+c.options.divID,e)}function r(){c.dropzone.destroy()}function a(t){t instanceof Array?$.when(c.build_tree(t)).then(function(t){return c.treeData=t,l[0]=t,c.flatten(c.treeData.children),t}).done(function(){n(),o()}):m.request({method:"GET",url:t}).then(function(t){c.treeData=c.build_tree(t)}).then(function(){l[0]=c.treeData,c.flatten(c.treeData.children)}).then(function(){n(),o(),console.log("FlatData",c.flatData),console.log("treeData",c.treeData)})}var c=this,h={asc:!1,desc:!1,column:""},p=0,f=0;this.flatData=[],this.treeData={},this.filterText=m.prop(""),this.showRange=[],this.options=d.options,this.selected=void 0,this.rangeMargin=0,this.visibleCache=0,this.visibleIndexes=[],this.visibleTop=[],this.currentPage=m.prop(1),this.dropzone=null,this.droppedItem={},this.filterOn=!1,this.build_tree=function(t,e){var o,n,i,r;if(Array.isArray(t)?(o=new s,n=t):(o=new s(t),n="undefined"!=typeof t.data?t.data[0].children:t.children,o.depth=e.depth+1,o.kind=t.kind),n){i=n.length;for(var a=0;i>a;a++)r=c.build_tree(n[a],o),o.add(r)}return o},this.flatten=function(t,e){c.flatData=[];var i=1,r=function a(t,r,s){for(var d=t.length,h=0;d>h;h++){i&&t[h].depth<=i&&(r=!0);for(var p=t[h].children,f=[],u={id:t[h].id,depth:t[h].depth,row:t[h].data},g=0;g<t[h].children.length;g++)f.push(t[h].children[g].id);u.row.children=f,u.row.show=r,t[h].children.length>0&&!t[h].data.open&&(r=!1,i>t[h].depth&&(i=t[h].depth)),c.flatData.push(u),p.length>0&&a(p,r,!1),l[t[h].id]=t[h],s&&h===d-1&&(n(e),o(),m.redraw())}};return r(t,!0,!0),t},this.redraw=function(){c.flatten(c.treeData.children,c.visibleTop)},this.init=function(e,n){if(!n){var r=$("#tb-tbody").height();c.options.showTotal=Math.floor(r/c.options.rowHeight),$("#tb-tbody").scroll(function(){var t=$(this).scrollTop(),e=t-p;e>0&&e<c.options.rowHeight&&$(this).scrollTop(p+c.options.rowHeight),0>e&&e>-c.options.rowHeight&&$(this).scrollTop(p-c.options.rowHeight);var n=o(),i=$(this).children(".tb-tbody-inner").outerHeight();t=$(this).scrollTop();var r=t/i*100,a=Math.round(r/100*c.visibleCache);c.rangeMargin=Math.round(n*(t/i)),c.refresh_range(a),m.redraw(!0),p=t}),c.options.allowMove&&t(),c.options.uploads&&i()}},this.delete_node=function(t,e){var o=l[e],n=$.extend({},o);$.when(c.options.deletecheck(o)).done(function(o){if(o){var i=l[t];i.remove_child(e),c.flatten(c.treeData.children,c.visibleTop),c.options.ondelete&&c.options.ondelete.call(c,n)}})},this.add_node=function(t){var e=new d.model,o=new s(e),n=l[t];n.add(o),c.flatten(c.treeData.children,c.visibleTop)},this.find=function(t){return l[t]},this.filter=function(t){m.withAttr("value",c.filterText)(t);var e=c.filterText().toLowerCase();if(0===e.length)c.filterOn=!1,n(0),o(),m.redraw(!0),$("#tb-tbody").scrollTop(f),c.options.onfilterreset&&c.options.onfilterreset.call(c,e);else{c.filterOn||(c.filterOn=!0,f=p);var i=c.visibleTop;c.visibleTop||(i=0),n(i),o(),m.redraw(!0),c.options.onfilter&&c.options.onfilter.call(c,e)}},this.toggle_folder=function(t,e,i){var r=c.flatData.length,a=l[c.flatData[e].id],s=c.flatData[e];if(c.options.lazyLoad&&"folder"===s.row.kind&&0===s.row.children.length)$.when(c.options.resolve_lazyload_url(c,a)).done(function(e){m.request({method:"GET",url:e}).then(function(t){var e,o;for(o=0;o<t.length;o++)e=c.build_tree(t[o],a),a.add(e);a.data.open=!0}).then(function(){c.flatten(c.treeData.children,t)})});else{for(var d=!1,h=s.depth,p=s.depth,f=e+1;r>f;f++){var u=c.flatData[f];if(u.depth<=p)break;d&&u.depth>h||(u.depth===h&&(d=!1),s.row.open?u.row.show=!1:(u.row.show=!0,u.row.open||(h=u.depth,d=!0)))}s.row.open=!s.row.open,n(t),o(),m.redraw(!0)}c.options.ontogglefolder&&c.options.ontogglefolder.call(c,a,i)},this.ascToggle=function(){var t=$(this).attr("data-direction"),e=$(this).attr("data-field"),o=$(this).parent();if($(".asc-btn, .desc-btn").addClass("tb-sort-inactive"),h.asc=!1,h.desc=!1,!h[t]){var n=0,i=function r(o){o.map(function(o){o.sort_children(t,e),o.children.length>0&&r(o.children),n++})};c.treeData.sort_children(t,e),i(c.treeData.children),o.children("."+t+"-btn").removeClass("tb-sort-inactive"),h[t]=!0,c.flatten(c.treeData.children,0)}},this.refresh_range=function(t){var e=c.visibleCache,o=[],n=0;c.visibleTop=t;for(var i=t;e>i&&o.length!==c.options.showTotal;i++){var r=c.visibleIndexes[i];o.push(r),n++}c.showRange=o,m.redraw(!0)},this.toggle_scroll=function(){c.options.paginate=!1,$(".tb-paginate").removeClass("active"),$(".tb-scroll").addClass("active"),c.refresh_range(0)},this.toggle_paginate=function(){c.options.paginate=!0,$(".tb-scroll").removeClass("active"),$(".tb-paginate").addClass("active");var t=c.showRange[0],e=c.visibleIndexes.indexOf(t),o=Math.floor(e/c.options.showTotal),n=o*c.options.showTotal;c.currentPage(o+1),c.refresh_range(n)},this.page_up=function(){var t=c.showRange[c.options.showTotal-1],e=c.visibleIndexes.indexOf(t);e>-1&&e+1<c.visibleCache&&(c.refresh_range(e+1),c.currentPage(c.currentPage()+1))},this.page_down=function(){var t=c.showRange[0],e=c.visibleIndexes.indexOf(t);e&&e>0&&(c.refresh_range(e-c.options.showTotal),c.currentPage(c.currentPage()-1))},this.go_to_page=function(t){if(t&&t>0&&t<=Math.ceil(c.visibleIndexes.length/c.options.showTotal)){var e=c.options.showTotal*(t-1);c.currentPage(t),c.refresh_range(e)}},a(d.options.filesData)},d.view=function(t){return console.log(t.showRange),[m(".gridWrapper.row",{config:t.init},[m(".col-sm-8",[m(".tb-table",[function(){return t.options.showFilter||t.options.title?m(".tb-head",[m(".row",[m(".col-xs-6",[m("h3.tb-grid-title",o(t.options.title))]),m(".col-xs-6",[function(){return t.options.showFilter?m("input.form-control[placeholder='filter'][type='text']",{style:"width:100%;display:inline;",onkeyup:t.filter,value:t.filterText()}):void 0}()])])]):void 0}(),m(".tb-row-titles.m-t-md",[t.options.columns.map(function(e){var o="";return e.sort&&(o=[m("i.fa.fa-sort-asc.tb-sort-inactive.asc-btn",{onclick:t.ascToggle,"data-direction":"asc","data-field":e.data}),m("i.fa.fa-sort-desc.tb-sort-inactive.desc-btn",{onclick:t.ascToggle,"data-direction":"desc","data-field":e.data})]),m(".tb-th",{style:"width: "+e.width},[m("span.padder-10",e.title),o])})]),m("#tb-tbody",[m(".tb-tbody-inner",[m("",{style:"padding-left: 15px;margin-top:"+t.rangeMargin+"px"},[t.showRange.map(function(e,o){var n="tb-odd";o%2===0&&(n="tb-even");var i,r,a=t.flatData[e].depth,s=t.flatData[e].id,d=t.flatData[e].row;return i=t.filterOn?0:20*a,r=s===t.selected?"tb-row-active":"",m(".tb-row",{"class":r+" "+n,"data-id":s,"data-level":a,"data-index":e,"data-rIndex":o,style:"height: "+t.options.rowHeight+"px;",onclick:function(e){t.selected=s,t.options.onselectrow&&t.options.onselectrow.call(t,l[d.id],e)}},[t.options.columns.map(function(o){var n;return n=m(".tb-td",{style:"width:"+o.width},[m("span",d[o.data])]),o.folderIcons===!0&&(n=m(".tb-td.td-title",{"data-id":s,style:"padding-left: "+i+"px; width:"+o.width},[m("span.tdFirst",{onclick:function(o){t.toggle_folder(t.visibleTop,e,o)}},function(){var e=l[d.id];return d.children.length>0||"folder"===d.kind?d.children.length>0&&d.open?[m("span.expand-icon-holder",m("i.fa.fa-minus-square-o"," ")),m("span.expand-icon-holder",t.options.resolve_icon.call(self,e))]:[m("span.expand-icon-holder",m("i.fa.fa-plus-square-o"," ")),m("span.expand-icon-holder",t.options.resolve_icon.call(self,e))]:[m("span.expand-icon-holder"),m("span.expand-icon-holder",t.options.resolve_icon.call(self,e))]}()),m("span.title-text",d[o.data]+" ")])),o.actionIcons===!0&&(n=m(".tb-td",{style:"width:"+o.width},[m("button.btn.btn-danger.btn-xs",{"data-id":s,onclick:function(){t.delete_node(d.parent,s)}}," X "),m("button.btn.btn-success.btn-xs",{"data-id":s,onclick:function(){t.add_node(s)}}," Add ")])),o.custom&&(n=m(".tb-td",{style:"width:"+o.width},[o.custom.call(d,o)])),n})])})])])]),function(){return t.options.paginate||t.options.paginateToggle?m(".tb-footer",[m(".row",[m(".col-xs-4",function(){return t.options.paginateToggle?m(".btn-group.padder-10",[m("button.btn.btn-default.btn-sm.active.tb-scroll",{onclick:t.toggle_scroll},"Scroll"),m("button.btn.btn-default.btn-sm.tb-paginate",{onclick:t.toggle_paginate},"Paginate")]):void 0}()),m(".col-xs-8",[m(".padder-10",[function(){if(t.options.paginate){var e=t.visibleIndexes.length,o=Math.ceil(e/t.options.showTotal);return m(".pull-right",[m("button.btn.btn-default.btn-sm",{onclick:t.page_down},[m("i.fa.fa-chevron-left")]),m("input.h-mar-10",{type:"text",style:"width: 30px;",onkeyup:function(e){var o=parseInt(e.target.value);t.go_to_page(o)},value:t.currentPage()}),m("span","/ "+o+" "),m("button.btn.btn-default.btn-sm",{onclick:t.page_up},[m("i.fa.fa-chevron-right")])])}}()])])])]):void 0}()])])])]},d.run=function(t){d.options=$.extend({divID:"myGrid",filesData:"small.json",rowHeight:35,showTotal:15,paginate:!1,paginateToggle:!1,lazyLoad:!1,uploads:!0,columns:[],showFilter:!0,title:!1,allowMove:!0,onfilter:function(t){console.log("on filter: this",this,"filterText",t)},onfilterreset:function(t){console.log("on filter reset: this",this,"filterText",t)},deletecheck:function(){},ondelete:function(){console.log("ondelete",this)},movecheck:function(t,e){return console.log("movecheck: to",t,"from",e),!0},onmove:function(t,e){console.log("onmove: to",t,"from",e)},addcheck:function(t,e,o){return console.log("Add check",this,t,e,o),!0},onadd:function(t,e,o,n){console.log("On add",this,t,e,o,n)},onselectrow:function(t,e){console.log("onselectrow",this,t,e)},ontogglefolder:function(t,e){console.log("ontogglefolder",this,t,e)},dropzone:{url:"http://www.torrentplease.com/dropzone.php",dragstart:function(){}},resolve_icon:function(t){return"folder"===t.kind?m("i.fa.fa-folder-o"," "):t.data.icon?m("i.fa."+t.icon," "):m("i.fa.fa-file ")},resolve_upload_url:function(){return"/upload"},resolve_lazyload_url:function(){return"small.json"}},t),m.module(document.getElementById(d.options.divID),d)},d});