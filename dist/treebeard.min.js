!function(t,e){"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?module.exports=e():t.Treebeard=e()}(this,function(){function t(){return a++}function e(t){return"[object Function]"===Object.prototype.toString.call(t)}function o(t){return t?e(t)?t():t:""}function n(t){return function(e,o){var n=e.data[t].toLowerCase().replace(/\s+/g," "),i=o.data[t].toLowerCase().replace(/\s+/g," ");return i>n?-1:n>i?1:0}}function i(t){return function(e,o){var n=e.data[t].toLowerCase().replace(/\s/g,""),i=o.data[t].toLowerCase().replace(/\s/g,"");return n>i?-1:i>n?1:0}}function r(t,e,o){for(var n=t.length;n--;)if(t[n]&&t[n].hasOwnProperty(e)&&arguments.length>2&&t[n][e]===o)return t.splice(n,1),!0;return!1}var a=0,s={},l=function(e){void 0===e?(this.data={},this.id=t()):(this.data=e,this.id=e.id||t()),this.depth=0,this.children=[],this.parentID=null,this.kind=null};l.prototype.add=function(t){return t.parentID=this.id,t.depth=this.depth+1,this.children.push(t),this.open=!0,this},l.prototype.move=function(t){var e=s[t],o=this.parentID,n=s[o];e.add(this),o>-1&&n.remove_child(parseInt(this.id))},l.prototype.remove_self=function(){{var t=this.parentID;r(t.children,"id",this.id)}return this},l.prototype.remove_child=function(t){r(this.children,"id",t);return this},l.prototype.next=function(){var t,e;e=s[this.parentID];for(var o=0;o<e.children.length;o++)e.children[o].id===this.id&&(t=e.children[o+1]);return t},l.prototype.prev=function(){var t,e;e=s[this.parentID];for(var o=0;o<e.children.length;o++)e.children[o].id===this.id&&(t=e.children[o-1]);return t},l.prototype.child=function(t){for(var e,o=0;o<this.children.length;o++)this.children[o].id===t&&(e=this.children[o]);return e},l.prototype.parent=function(){return s[this.parentID]},l.prototype.sort_children=function(t,e){"asc"===t&&this.children.sort(n(e)),"desc"===t&&this.children.sort(i(e))};var d={};return d.model=function(){return{id:Math.floor(1e4*Math.random()),load:!0,status:!0,show:!0,loadUrl:"small.json",person:"JohnnyB. Goode",name:"Around the World in 80 Days",date:"Date",filtered:!1,kind:"file",children:[]}},d.controller=function(){function t(t){var e=a.filterText().toLowerCase(),o=t.title.toLowerCase().indexOf(e);return o>-1?!0:!1}function e(){var t;if(a.paginate)t=a.options.showTotal*a.options.rowHeight,a.rangeMargin=0;else{var e=a.visibleCache;t=e*a.options.rowHeight}return $(".tb-tbody-inner").height(t),t}function o(e){e=e||0;var o=a.flatData.length,n=0;a.visibleIndexes=[];for(var i=0;o>i;i++){var r=a.flatData[i].row;c?t(r)&&(n++,a.visibleIndexes.push(i)):r.show&&(a.visibleIndexes.push(i),n++)}return a.visibleCache=n,a.refresh_range(e),n}function n(){a.dropzone&&i();var t=["drop","dragstart","dragend","dragenter","dragover","dragleave","addedfile","removedfile","thumbnail","error","processing","uploadprogress","sending","success","complete","canceled","maxfilesreached","maxfilesexceeded"],e=$.extend({init:function(){for(var e=0;e<t.length;e++){var o=t[e];a.options.dropzone[o]&&this.on(o,function(t){a.options.dropzone[o].call(a,t)})}},accept:function(t,e){a.options.addcheck(a.droppedItem,t)?$.when(a.options.resolve_upload_url(a.droppedItem)).then(function(t){return t&&(a.dropzone.url=t),t}).done(function(){e()}):alert("This isn't allowed")},drop:function(t){var e=$(t.target).closest(".tb-row").attr("data-id"),o=s[e];a.droppedItem=o},success:function(){var t=new d.model,e=new l(t);a.droppedItem.add(e),a.flatten(a.treeData.children,a.visibleTop)}},a.options.dropzone);a.dropzone=new Dropzone("#"+a.options.divID,e)}function i(){a.dropzone.destroy()}function r(t){t instanceof Array?$.when(a.build_tree(t)).then(function(t){return a.treeData=t,s[0]=t,a.flatten(a.treeData.children),t}).done(function(){o(),e()}):this.data=m.request({method:"GET",url:t}).then(function(t){a.treeData=a.build_tree(t)}).then(function(){s[0]=a.treeData,a.flatten(a.treeData.children)}).then(function(){o(),e(),console.log("FlatData",a.flatData),console.log("treeData",a.treeData)})}var a=this,c=!1,h={asc:!1,desc:!1,column:""},p=0,u=0;this.flatData=[],this.treeData={},this.filterText=m.prop(""),this.showRange=[],this.options=d.options,this.selected=void 0,this.rangeMargin=0,this.visibleCache=0,this.visibleIndexes=[],this.visibleTop=[],this.currentPage=m.prop(1),this.dropzone=null,this.droppedItem={},this.build_tree=function(t,e){var o,n,i,r;if(Array.isArray(t)?(o=new l,n=t):(o=new l(t),n="undefined"!=typeof t.data?t.data[0].children:t.children,o.depth=e.depth+1,o.kind=t.kind),n){i=n.length;for(var s=0;i>s;s++)r=a.build_tree(n[s],o),o.add(r)}return o},this.flatten=function(t,n){a.flatData=[];var i=1,r=function l(t,r,d){for(var c=t.length,h=0;c>h;h++){i&&t[h].depth<=i&&(r=!0);for(var p=t[h].children,u=[],f={id:t[h].id,depth:t[h].depth,row:t[h].data},g=0;g<t[h].children.length;g++)u.push(t[h].children[g].id);f.row.children=u,f.row.show=r,t[h].children.length>0&&!t[h].data.open&&(r=!1,i>t[h].depth&&(i=t[h].depth)),a.flatData.push(f),p.length>0&&l(p,r,!1),s[t[h].id]=t[h],d&&h===c-1&&(o(n),e(),m.redraw())}};return r(t,!0,!0),t},this.redraw=function(){a.flatten(a.treeData.children,a.visibleTop)},this.init=function(t,o){if(!o){var i=$("#tb-tbody").height();a.options.showTotal=Math.floor(i/a.options.rowHeight),$("#tb-tbody").scroll(function(){var t=$(this).scrollTop(),o=t-p;o>0&&o<a.options.rowHeight&&$(this).scrollTop(p+a.options.rowHeight),0>o&&o>-a.options.rowHeight&&$(this).scrollTop(p-a.options.rowHeight);var n=e(),i=$(this).children(".tb-tbody-inner").outerHeight();t=$(this).scrollTop();var r=t/i*100,s=Math.round(r/100*a.visibleCache);a.rangeMargin=Math.round(n*(t/i)),a.refresh_range(s),m.redraw(!0),p=t}),$(".td-title").draggable({helper:"clone"}),$(".tb-row").droppable({tolerance:"touch",cursor:"move",out:function(){$(".tb-row.tb-h-success").removeClass("tb-h-success"),$(".tb-row.tb-h-error").removeClass("tb-h-error")},over:function(t,e){var o=$(this).attr("data-id"),n=e.draggable.attr("data-id"),i=s[o],r=s[n];$(this).addClass(o!==n&&a.options.movecheck(i,r)?"tb-h-success":"tb-h-error")},drop:function(t,e){var o=$(this).attr("data-id"),n=e.draggable.attr("data-id"),i=s[o],r=s[n];o!==n&&(a.options.movecheck(i,r)?(r.move(o),a.flatten(a.treeData.children,a.visibleTop)):alert("You can't move your item here.")),a.options.onmove&&a.options.onmove(i,r)}}),a.options.uploads&&n()}},this.delete_node=function(t,e){var o=s[t];o.remove_child(e),a.options.ondelete&&a.options.ondelete.call(o),a.flatten(a.treeData.children,a.visibleTop)},this.add_node=function(t){var e=new d.model,o=new l(e),n=s[t];n.add(o),a.flatten(a.treeData.children,a.visibleTop)},this.find=function(t){return s[t]},this.filter=function(t){m.withAttr("value",a.filterText)(t);var n=a.filterText().toLowerCase();if(0===n.length)c=!1,o(0),e(),m.redraw(!0),$("#tb-tbody").scrollTop(u),a.options.onfilterreset(n);else{c||(c=!0,u=p);var i=a.visibleTop;a.visibleTop||(i=0),o(i),e(),m.redraw(!0),a.options.onfilter(n)}},this.toggle_folder=function(t,n){var i=a.flatData.length,r=s[a.flatData[n].id],l=a.flatData[n];if(a.options.lazyLoad&&"folder"===l.row.kind&&0===l.row.children.length)$.when(a.options.resolve_lazyload_url(r)).done(function(e){m.request({method:"GET",url:e}).then(function(t){var e,o;for(o=0;o<t.length;o++)e=a.build_tree(t[o],r),r.add(e);r.data.open=!0}).then(function(){a.flatten(a.treeData.children,t)})});else{for(var d=!1,c=l.depth,h=l.depth,p=n+1;i>p;p++){var u=a.flatData[p];if(u.depth<=h)break;d&&u.depth>c||(u.depth===c&&(d=!1),l.row.open?u.row.show=!1:(u.row.show=!0,u.row.open||(c=u.depth,d=!0)))}l.row.open=!l.row.open,o(t),e(),m.redraw(!0)}a.options.ontogglefolder&&a.options.ontogglefolder.call(r)},this.ascToggle=function(){var t=$(this).attr("data-direction"),e=$(this).attr("data-field"),o=$(this).parent();if($(".asc-btn, .desc-btn").addClass("tb-sort-inactive"),h.asc=!1,h.desc=!1,!h[t]){var n=0,i=function r(o){o.map(function(o){o.sort_children(t,e),o.children.length>0&&r(o.children),n++})};a.treeData.sort_children(t,e),i(a.treeData.children),o.children("."+t+"-btn").removeClass("tb-sort-inactive"),h[t]=!0,a.flatten(a.treeData.children,0)}},this.refresh_range=function(t){var e=a.visibleCache,o=[],n=0;a.visibleTop=t;for(var i=t;e>i&&o.length!==a.options.showTotal;i++){var r=a.visibleIndexes[i];o.push(r),n++}a.showRange=o,m.redraw(!0)},this.toggle_scroll=function(){a.options.paginate=!1,$(".tb-paginate").removeClass("active"),$(".tb-scroll").addClass("active"),a.refresh_range(0)},this.toggle_paginate=function(){a.options.paginate=!0,$(".tb-scroll").removeClass("active"),$(".tb-paginate").addClass("active");var t=a.showRange[0],e=a.visibleIndexes.indexOf(t),o=Math.floor(e/a.options.showTotal),n=o*a.options.showTotal;a.currentPage(o+1),a.refresh_range(n)},this.page_up=function(){var t=a.showRange[a.options.showTotal-1],e=a.visibleIndexes.indexOf(t);e>-1&&e+1<a.visibleCache&&(a.refresh_range(e+1),a.currentPage(a.currentPage()+1))},this.page_down=function(){var t=a.showRange[0],e=a.visibleIndexes.indexOf(t);e&&e>0&&(a.refresh_range(e-a.options.showTotal),a.currentPage(a.currentPage()-1))},this.jump_to_page=function(t){var e=parseInt(t.target.value);if(e&&e>0&&e<=Math.ceil(a.visibleIndexes.length/a.options.showTotal)){m.withAttr("value",a.currentPage)(t);var o=parseInt(a.currentPage()),n=a.options.showTotal*(o-1);a.refresh_range(n)}},this.data=r(d.options.filesData)},d.view=function(t){return console.log(t.showRange),[m(".gridWrapper.row",{config:t.init},[m(".col-sm-8",[m(".tb-table",[function(){return t.options.showFilter||t.options.title?m(".tb-head",[m(".row",[m(".col-xs-6",[m("h3.tb-grid-title",o(t.options.title))]),m(".col-xs-6",[function(){return t.options.showFilter?m("input.form-control[placeholder='filter'][type='text']",{style:"width:100%;display:inline;",onkeyup:t.filter,value:t.filterText()}):void 0}()])])]):void 0}(),m(".tb-row-titles.m-t-md",[t.options.columns.map(function(e){var o="";return e.sort&&(o=[m("i.fa.fa-sort-asc.tb-sort-inactive.asc-btn",{onclick:t.ascToggle,"data-direction":"asc","data-field":e.data}),m("i.fa.fa-sort-desc.tb-sort-inactive.desc-btn",{onclick:t.ascToggle,"data-direction":"desc","data-field":e.data})]),m(".tb-th",{style:"width: "+e.width},[m("span.padder-10",e.title),o])})]),m("#tb-tbody",[m(".tb-tbody-inner",[m("",{style:"padding-left: 15px;margin-top:"+t.rangeMargin+"px"},[t.showRange.map(function(e,o){var n,i,r=t.flatData[e].depth,a=t.flatData[e].id,l=t.flatData[e].row;return n=t.filterOn?0:20*r,i=a===t.selected?"tb-row-active":"",m(".tb-row",{"class":i,"data-id":a,"data-level":r,"data-index":e,"data-rIndex":o,style:"height: "+t.options.rowHeight+"px;",onclick:function(){t.selected=a,t.options.onselectrow&&t.options.onselectrow.call(s[l.id])}},[t.options.columns.map(function(o){var i;return i=m(".tb-td",{style:"width:"+o.width},[m("span",l[o.data])]),o.folderIcons===!0&&(i=m(".tb-td.td-title",{"data-id":a,style:"padding-left: "+n+"px; width:"+o.width},[m("span.tdFirst",{onclick:function(){t.toggle_folder(t.visibleTop,e)}},function(){var e=s[l.id];return l.children.length>0||"folder"===l.kind?l.children.length>0&&l.open?[m("span.expand-icon-holder",m("i.fa.fa-minus-square-o"," ")),m("span.expand-icon-holder",t.options.resolve_icon(e))]:[m("span.expand-icon-holder",m("i.fa.fa-plus-square-o"," ")),m("span.expand-icon-holder",t.options.resolve_icon(e))]:[m("span.expand-icon-holder"),m("span.expand-icon-holder",t.options.resolve_icon(e))]}()),m("span.title-text",l[o.data]+" ")])),o.actionIcons===!0&&(i=m(".tb-td",{style:"width:"+o.width},[m("button.btn.btn-danger.btn-xs",{"data-id":a,onclick:function(){t.delete_node(l.parent,a)}}," X "),m("button.btn.btn-success.btn-xs",{"data-id":a,onclick:function(){t.add_node(a)}}," Add "),m("button.btn.btn-info.btn-xs",{"data-id":a,onclick:function(){var t='.tb-row[data-id="'+a+'"]';$(t).css("font-weight","bold")}},"?")])),o.custom&&(i=m(".tb-td",{style:"width:"+o.width},[o.custom.call(l,o)])),i})])})])])]),function(){return t.options.paginate||t.options.paginateToggle?m(".tb-footer",[m(".row",[m(".col-xs-4",function(){return t.options.paginateToggle?m(".btn-group.padder-10",[m("button.btn.btn-default.btn-sm.active.tb-scroll",{onclick:t.toggle_scroll},"Scroll"),m("button.btn.btn-default.btn-sm.tb-paginate",{onclick:t.toggle_paginate},"Paginate")]):void 0}()),m(".col-xs-8",[m(".padder-10",[function(){return t.options.paginate?m(".pull-right",[m("button.btn.btn-default.btn-sm",{onclick:t.page_down},[m("i.fa.fa-chevron-left")]),m("input.h-mar-10",{type:"text",style:"width: 30px;",onkeyup:t.jump_to_page,value:t.currentPage()}),m("span","/ "+Math.ceil(t.visibleIndexes.length/t.options.showTotal)+" "),m("button.btn.btn-default.btn-sm",{onclick:t.page_up},[m("i.fa.fa-chevron-right")])]):void 0}()])])])]):void 0}()])])])]},d.run=function(t){d.options=$.extend({divID:"myGrid",filesData:"small.json",rowHeight:35,showTotal:15,paginate:!1,paginateToggle:!1,lazyLoad:!1,uploads:!0,columns:[],showFilter:!1,title:!1,onfilter:function(){},onfilterreset:function(){},deletecheck:function(){},ondelete:function(){console.log("ondelete",this)},movecheck:function(t,e){return console.log("movecheck: to",t,"from",e),!0},onmove:function(t,e){console.log("onmove: to",t,"from",e)},addcheck:function(){return!0},onadd:function(){},onselectrow:function(){console.log("onselectrow",this)},ontogglefolder:function(){console.log("ontogglefolder",this)},dropzone:{url:"http://www.torrentplease.com/dropzone.php",dropend:function(){}},resolve_icon:function(t){return"folder"===t.kind?m("i.fa.fa-folder-o"," "):t.data.icon?m("i.fa."+t.icon," "):m("i.fa.fa-file ")},resolve_upload_url:function(){return"/upload"},resolve_lazyload_url:function(){return"small.json"}},t),m.module(document.getElementById(d.options.divID),d)},d});