!function(t,e){"use strict";"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?module.exports=e():t.Treebeard=e()}(this,function(){"use strict";function t(){return c+=1}function e(t){return"[object Function]"===Object.prototype.toString.call(t)}function o(t){return t?e(t)?t():t:""}function n(t,e){return"number"===e?function(t,e){return t-e}:function(e,o){var n=e.data[t].toLowerCase().replace(/\s+/g," "),i=o.data[t].toLowerCase().replace(/\s+/g," ");return i>n?-1:n>i?1:0}}function i(t,e){return"number"===e?function(t,e){return e-t}:function(e,o){var n=e.data[t].toLowerCase().replace(/\s/g,""),i=o.data[t].toLowerCase().replace(/\s/g,"");return n>i?-1:i>n?1:0}}function r(t,e,o){var n;for(n=0;n<t.length;n++)if(t[n]&&t[n].hasOwnProperty(e)&&arguments.length>2&&t[n][e]===o)return t.splice(n,1),!0;return!1}var s,a={},l={},c=-1;return s=function(e){void 0===e?(this.data={},this.kind="folder",this.open=!0):(this.data=e,this.kind=e.kind||"item",this.open=e.open),this.id=t(),this.depth=0,this.children=[],this.parentID=null},s.prototype.add=function(t,e){return t.parentID=this.id,t.depth=this.depth+1,e?this.children.unshift(t):this.children.push(t),this},s.prototype.move=function(t){var e=a[t],o=this.parentID,n=a[o];e.add(this),e.redoDepth(),o>-1&&n.removeChild(parseInt(this.id,10))},s.prototype.redoDepth=function(){function t(o,n){for(e=0;e<o.length;e++)o[e].depth=n,o[e].children.length>0&&t(o[e].children,n+1)}var e;t(this.children,this.depth+1)},s.prototype.removeSelf=function(){var t=this.parent();return t.removeChild(this.id),this},s.prototype.removeChild=function(t){return r(this.children,"id",t),this},s.prototype.next=function(){var t,e,o;for(e=a[this.parentID],o=0;o<e.children.length;o++)if(e.children[o].id===this.id)return t=e.children[o+1];if(!t)throw new Error("Treebeard Error: Item with ID '"+this.id+"' has no next sibling")},s.prototype.prev=function(){var t,e,o;for(e=a[this.parentID],o=0;o<e.children.length;o++)if(e.children[o].id===this.id)return t=e.children[o-1];if(!t)throw new Error("Treebeard Error: Item with ID '"+this.id+"' has no previous sibling")},s.prototype.child=function(t){var e,o;for(o=0;o<this.children.length;o++)if(this.children[o].id===t)return e=this.children[o];if(!e)throw new Error("Treebeard Error: Parent with ID '"+this.id+"' has no child with ID: "+t)},s.prototype.parent=function(){return a[this.parentID]?a[this.parentID]:void 0},s.prototype.sortChildren=function(t,e,o){t.options.resolveRows(this);if(!e)throw new Error("Treebeard Error: To sort children you need to pass direction to Item.sortChildren");this.children.length>0&&("asc"===e&&this.children.sort(n(field,o)),"desc"===e&&this.children.sort(i(field,o)))},s.prototype.isAncestor=function(t){function e(t,o){return t.id===o.id?!0:t.parent()?e(t.parent(),o):!1}return e(t.parent(),this)},s.prototype.isDescendant=function(t){function e(t,i){for(o=0;o<t.length;o++){if(t[o].id===i.id){n=!0;break}if(t[o].children.length>0)return e(t[o].children,i)}return n}var o,n=!1;return e(t.children,this)},l.controller=function(){function t(){$(".td-title").draggable({helper:"clone",delay:300,drag:function(t,e){$(e.helper).css({height:"25px",width:"400px",background:"white",padding:"0px 10px","box-shadow":"0 0 4px #ccc"})}}),$(".tb-row").droppable({tolerance:"fit",cursor:"move",out:function(){$(".tb-row.tb-h-success").removeClass("tb-h-success"),$(".tb-row.tb-h-error").removeClass("tb-h-error")},over:function(t,e){var o,n,i,r;o=$(this).attr("data-id"),n=e.draggable.attr("data-id"),i=a[o],r=a[n],$(this).addClass(o!==n&&d.options.movecheck(i,r)&&d.canMove(i,r)?"tb-h-success":"tb-h-error")},drop:function(t,e){var o,n,i,r;o=$(this).attr("data-id"),n=e.draggable.attr("data-id"),i=a[o],r=a[n],o!==n&&(d.options.movecheck.call(d,i,r)&&d.canMove(i,r)?(r.move(o),d.flatten(d.treeData.children,d.visibleTop),d.options.onmove&&d.options.onmove(i,r)):d.options.movefail?d.options.movefail.call(d,i,r):window.alert("You can't move your item here.")),$(".tb-row.tb-h-success").removeClass("tb-h-success"),$(".tb-row.tb-h-error").removeClass("tb-h-error")}})}function e(t){$("#tb-tbody").scrollTop(0),d.currentPage(1);var e,o,n=d.filterText().toLowerCase(),i=!1;for(e=0;e<d.options.columns.length;e++)o=d.options.columns[e],o.filter&&-1!==t[o.data].toLowerCase().indexOf(n)&&(i=!0);return i}function o(){var t;return d.options.paginate?(t=d.options.showTotal*d.options.rowHeight,d.rangeMargin=0):t=d.visibleIndexes.length*d.options.rowHeight,$(".tb-tbody-inner").height(t),t}function n(t){t=t||0;var o,n,i=d.flatData.length,r=0;for(d.visibleIndexes=[],o=0;i>o;o++)n=d.flatData[o].row,d.filterOn?e(n)&&(r++,d.visibleIndexes.push(o)):d.flatData[o].show&&(d.visibleIndexes.push(o),r+=1);return d.refreshRange(t),r}function i(){d.dropzone.destroy()}function r(){d.dropzone&&i();var t=$.extend({clickable:!1,accept:function(t,e){d.options.addcheck.call(this,d,d.dropzoneItemCache,t)&&$.when(d.options.resolveUploadUrl.call(d,d.dropzoneItemCache)).then(function(t){return t&&(d.dropzone.options.url=t),t}).done(function(){e()})},drop:function(t){var e=$(t.target).closest(".tb-row").attr("data-id"),o=a[e];d.dropzoneItemCache=o},success:function(t,e){$.isFunction(d.options.dropzoneEvents.success)&&d.options.dropzoneEvents.success.call(this,d,t,e),$.isFunction(d.options.onadd)&&d.options.onadd.call(this,d,d.dropzoneItemCache,t,e)},error:function(t,e,o){$.isFunction(d.options.dropzoneEvents.error)&&d.options.dropzoneEvents.error.call(this,d,t,e,o)},uploadprogress:function(t,e,o){$.isFunction(d.options.dropzoneEvents.uploadprogress)&&d.options.dropzoneEvents.uploadprogress.call(this,d,t,e,o)},sending:function(t,e,o){$.isFunction(d.options.dropzoneEvents.sending)&&d.options.dropzoneEvents.sending.call(this,d,t,e,o)},complete:function(t){$.isFunction(d.options.dropzoneEvents.complete)&&d.options.dropzoneEvents.complete.call(this,d,t)}},d.options.dropzone);d.dropzone=new Dropzone("#"+d.options.divID,t)}function c(t){if($.isArray(t))$.when(d.buildTree(t)).then(function(t){return d.treeData=t,a[0]=t,d.flatten(d.treeData.children),t}).done(function(){n(),o()});else{var e=new RegExp("(http|ftp|https)://[w-]+(.[w-]*)+([w.,@?^=%&amp;:/~+#-]*[w@?^=%&amp;/~+#-])?");if(-1===d.options.filesData.indexOf("localhost")&&!e.test(d.options.filesData))throw new Error("Treebeard Error: Your URL is not valid. Include full path. You provided: "+d.options.filesData);m.request({method:"GET",url:t}).then(function(t){d.treeData=d.buildTree(t)}).then(function(){a[0]=d.treeData,d.flatten(d.treeData.children)}).then(function(){n(),o()})}}var d=this,h={asc:!1,desc:!1,column:""},p=0,u=0;if(m.redraw.strategy("all"),this.flatData=[],this.treeData={},this.filterText=m.prop(""),this.showRange=[],this.options=l.options,this.selected=void 0,this.mouseon=void 0,this.rangeMargin=0,this.visibleIndexes=[],this.visibleTop=void 0,this.currentPage=m.prop(1),this.dropzone=null,this.dropzoneItemCache=void 0,this.filterOn=!1,this.redraw=function(){d.flatten(d.treeData.children,d.visibleTop)},this.deleteNode=function(t,e){var o=a[e],n=$.extend({},o);$.when(d.options.deletecheck.call(d,o)).done(function(o){if(o){var i=a[t];i.removeChild(e),d.flatten(d.treeData.children,d.visibleTop),d.options.ondelete&&d.options.ondelete.call(d,n)}})},this.canMove=function(t,e){return"folder"!==t.kind?!1:t.isDescendant(e)?!1:!0},this.createItem=function(t,e){var o,n=a[e];return $.when(d.options.createcheck.call(d,t,n)).done(function(e){if(!e)throw new Error("Treebeard Error: createcheck function returned false, item not created.");o=new s(t),n.add(o,!0),d.flatten(d.treeData.children,d.visibleTop),d.options.oncreate&&d.options.oncreate.call(d,o,n)}),o},this.find=function(t){return a[t]?a[t]:void 0},this.returnIndex=function(t){var e,o,n=d.flatData.length;for(e=0;n>e;e++)if(o=d.flatData[e],o.row.id===t)return e;return void 0},this.filter=function(t){m.withAttr("value",d.filterText)(t);var e=d.filterText().toLowerCase(),i=d.visibleTop;0===e.length?(d.filterOn=!1,n(0),o(),m.redraw(!0),$("#tb-tbody").scrollTop(u),d.options.onfilterreset&&d.options.onfilterreset.call(d,e)):(d.filterOn||(d.filterOn=!0,u=p),d.visibleTop||(i=0),n(i),o(),m.redraw(!0),d.options.onfilter&&d.options.onfilter.call(d,e))},this.toggleFolder=function(e,i){var r,s,l,c,h,p=d.flatData.length,u=a[d.flatData[e].id],f=d.flatData[e],g=!1,v=f.depth,w=f.depth;if(d.options.resolveLazyloadUrl&&"folder"===f.row.kind&&0===f.row.children.length)$.when(d.options.resolveLazyloadUrl(d,u)).done(function(t){m.request({method:"GET",url:t}).then(function(t){for(s=0;s<t.length;s++)r=d.buildTree(t[s],u),u.add(r);u.open=!0}).then(function(){d.flatten(d.treeData.children,topIndex)})});else{for(l=e+1;p>l&&(c=d.flatData[l],h=a[d.flatData[l].id],!(c.depth<=w));l++)g&&c.depth>v||(c.depth===v&&(g=!1),u.open?c.show=!1:(c.show=!0,h.open||(v=c.depth,g=!0)));u.open=!u.open,n(d.visibleTop),o(),m.redraw(!0)}t(),d.options.ontogglefolder&&d.options.ontogglefolder.call(d,u,i)},this.sortToggle=function(){var t,e=$(this).attr("data-direction"),o=$(this).attr("data-sortType"),n=$(this).parent(),i=0;$(".asc-btn, .desc-btn").addClass("tb-sort-inactive"),h.asc=!1,h.desc=!1,h[e]||(t=function(n){n.map(function(n){n.sortChildren(d,e,o),n.children.length>0&&t(n.children),i+=1})},d.treeData.sortChildren(d,e,o),t(d.treeData.children),n.children("."+e+"-btn").removeClass("tb-sort-inactive"),h[e]=!0,d.flatten(d.treeData.children,0))},this.refreshRange=function(t){var e,o,n=d.visibleIndexes.length,i=[],r=0;for(d.visibleTop=t,e=t;n>e&&i.length!==d.options.showTotal;e++)o=d.visibleIndexes[e],i.push(o),r+=1;d.showRange=i,m.redraw(!0)},this.toggleScroll=function(){d.options.paginate=!1,$(".tb-paginate").removeClass("active"),$(".tb-scroll").addClass("active"),$("#tb-tbody").scrollTop((d.currentPage()-1)*d.options.showTotal*d.options.rowHeight),o()},this.togglePaginate=function(){var t=d.showRange[0],e=d.visibleIndexes.indexOf(t),n=Math.floor(e/d.options.showTotal),i=n*d.options.showTotal;d.options.paginate=!0,$(".tb-scroll").removeClass("active"),$(".tb-paginate").addClass("active"),d.currentPage(n+1),o(),d.refreshRange(i)},this.pageUp=function(){var t=d.showRange[d.options.showTotal-1],e=d.visibleIndexes.indexOf(t);e>-1&&e+1<d.visibleIndexes.length&&(d.refreshRange(e+1),d.currentPage(d.currentPage()+1))},this.pageDown=function(){var t=d.showRange[0],e=d.visibleIndexes.indexOf(t);e&&e>0&&(d.refreshRange(e-d.options.showTotal),d.currentPage(d.currentPage()-1))},this.goToPage=function(t){if(t&&t>0&&t<=Math.ceil(d.visibleIndexes.length/d.options.showTotal)){var e=d.options.showTotal*(t-1);d.currentPage(t),d.refreshRange(e)}},this.buildTree=function(t,e){var o,n,i,r,a;if(Array.isArray(t)?(o=new s,n=t):(o=new s(t),n=t.children,o.depth=e.depth+1,t.open||0===e.depth&&(o.open=!0)),n)for(i=n.length,a=0;i>a;a++)r=d.buildTree(n[a],o),o.add(r);return o},this.flatten=function(t,e){d.flatData=[];var i,r=function s(t,r,l){var c,h,p,u=t.length;for(c=0;u>c;c++)i&&t[c].depth<=i&&(r=!0),h=t[c].children,p={id:t[c].id,depth:t[c].depth,row:t[c].data},p.show=r,t[c].children.length>0&&!t[c].open&&(r=!1,(!i||i>t[c].depth)&&(i=t[c].depth)),d.flatData.push(p),h.length>0&&s(h,r,!1),a[t[c].id]=t[c],l&&c===u-1&&(n(e),o(),m.redraw(!0))};return r(t,!0,!0),t},this.init=function(e,n){if(!n){var i=$("#tb-tbody").height();d.options.showTotal=Math.floor(i/d.options.rowHeight),d.options.rowHeight||(d.options.rowHeight=$(".tb-row").height()),$("#tb-tbody").scroll(function(){if(!d.options.paginate){var t,e,n,i,r,s;t=$(this).scrollTop(),e=t-p,e>0&&e<d.options.rowHeight&&$(this).scrollTop(p+d.options.rowHeight),0>e&&e>-d.options.rowHeight&&$(this).scrollTop(p-d.options.rowHeight),n=o(),i=$(this).children(".tb-tbody-inner").outerHeight(),t=$(this).scrollTop(),r=t/i*100,s=Math.round(r/100*d.visibleIndexes.length),d.rangeMargin=Math.round(n*(t/i)),d.refreshRange(s),m.redraw(!0),p=t}}),d.options.allowMove&&t(),d.options.uploads&&r(),$.isFunction(d.options.onload)&&d.options.onload.call(d)}},!d.options.filesData)throw new Error("Treebeard Error: You need to define a data source through 'options.filesData'");c(d.options.filesData)},l.view=function(t){return[m(".gridWrapper",{config:t.init},[m(".tb-table",[function(){return t.options.showFilter||t.options.title?m(".tb-head",[m(".tb-head-title",[m("h3",o(t.options.title))]),m(".tb-head-filter",[function(){return t.options.showFilter?m("input.form-control[placeholder='filter'][type='text']",{style:"width:100%;display:inline;",onkeyup:t.filter,value:t.filterText()}):void 0}()])]):void 0}(),m(".tb-row-titles",[t.options.columnTitles.map(function(e,o){var n,i,r="";return e.sort&&(n=t.options.sortButtonSelector.up?t.options.sortButtonSelector.up:"i.fa.fa-sort-asc",i=t.options.sortButtonSelector.down?t.options.sortButtonSelector.down:"i.fa.fa-sort-desc",r=[m(n+".tb-sort-inactive.asc-btn.m-r-xs",{onclick:t.sortToggle(o),"data-direction":"asc"}),m(i+".tb-sort-inactive.desc-btn",{onclick:t.sortToggle(o),"data-direction":"desc"})]),m(".tb-th",{style:"width: "+e.width},[m("span.padder-10.m-r-sm",e.title),r])})]),m("#tb-tbody",[m(".tb-tbody-inner",[m("",{style:"margin-top:"+t.rangeMargin+"px"},[t.showRange.map(function(e,o){var n,i="tb-odd",r=t.flatData[e].depth,s=t.flatData[e].id,l=a[s],c=t.flatData[e].row,d="";return o%2===0&&(i="tb-even"),n=t.filterOn?20:20*r,m(".tb-row",{key:s,"class":d+" "+i,"data-id":s,"data-level":r,"data-index":e,"data-rIndex":o,style:"height: "+t.options.rowHeight+"px;",onclick:function(e){t.selected=s,t.options.onselectrow&&t.options.onselectrow.call(t,l,e)},onmouseover:function(e){t.mouseon=s,t.options.hoverClass&&($(".tb-row").removeClass(t.options.hoverClass),$(this).addClass(t.options.hoverClass)),t.options.onmouseoverrow&&t.options.onmouseoverrow.call(t,l,e)}},[t.options.columns.map(function(o){var i,r;return i=m(".tb-td",{"class":o.css,style:"width:"+o.width},[m("span",c[o.data])]),o.folderIcons&&(r=o.custom?m("span.title-text",o.custom.call(t,l,o)):m("span.title-text",c[o.data]+" "),i=m(".tb-td.td-title",{"data-id":s,"class":o.css,style:"padding-left: "+n+"px; width:"+o.width},[m("span.tdFirst",{onclick:function(o){t.options.togglecheck.call(t,l)&&t.toggleFolder(e,o)}},function(){var e=m("span.tb-expand-icon-holder",t.options.resolveIcon.call(t,l)),o=m("span.tb-expand-icon-holder",t.options.resolveToggle.call(t,l));return t.filterOn?e:[o,e]}()),r])),!o.folderIcons&&o.custom&&(i=m(".tb-td",{"class":o.css,style:"width:"+o.width},[o.custom.call(t,l,o)])),i})])})])])]),function(){return t.options.paginate||t.options.paginateToggle?m(".tb-footer",[m(".row",[m(".col-xs-4",function(){if(t.options.paginateToggle){var e="",o="";return t.options.paginate?o="active":e="active",m(".btn-group.padder-10",[m("button.btn.btn-default.btn-sm.tb-scroll",{onclick:t.toggleScroll,"class":e},"Scroll"),m("button.btn.btn-default.btn-sm.tb-paginate",{onclick:t.togglePaginate,"class":o},"Paginate")])}}()),m(".col-xs-8",[m(".padder-10",[function(){if(t.options.paginate){var e=t.visibleIndexes.length,o=Math.ceil(e/t.options.showTotal);return t.options.resolvePagination?t.options.resolvePagination.call(t,o,t.currentPage()):m(".tb-pagination.pull-right",[m("button.tb-pagination-prev.btn.btn-default.btn-sm.m-r-sm",{onclick:t.pageDown},[m("i.fa.fa-chevron-left")]),m("input.tb-pagination-input.m-r-sm",{type:"text",style:"width: 30px;",onkeyup:function(e){var o=parseInt(e.target.value,10);t.goToPage(o)},value:t.currentPage()}),m("span.tb-pagination-span","/ "+o+" "),m("button.tb-pagination-next.btn.btn-default.btn-sm",{onclick:t.pageUp},[m("i.fa.fa-chevron-right")])])}}()])])])]):void 0}()])])]},l.run=function(t){return l.options=$.extend({divID:"myGrid",filesData:"http://localhost:63342/mGrid/demo/small.json",rowHeight:void 0,showTotal:15,paginate:!1,paginateToggle:!1,uploads:!0,columnTitles:[{title:"Title",width:"50%",sortType:"text"}],resolveRows:function(){return[{data:"title",folderIcons:!0,sortBy:"title",sort:!0}]},hoverClass:void 0,showFilter:!0,title:"Grid Title",allowMove:!0,sortButtonSelector:{},onload:function(){console.log("onload this",this)},togglecheck:function(){return!0},onfilter:function(t){window.console.log("on filter: this",this,"filterText",t)},onfilterreset:function(t){window.console.log("on filter reset: this",this,"filterText",t)},createcheck:function(t,e){return window.console.log("createcheck",this,t,e),!0},oncreate:function(t,e){window.console.log("oncreate",this,t,e)},deletecheck:function(t){return window.console.log("deletecheck",this,t),!0},ondelete:function(){window.console.log("ondelete",this)},movecheck:function(t,e){return window.console.log("movecheck: to",t,"from",e),!0},onmove:function(t,e){window.console.log("onmove: to",t,"from",e)},movefail:function(t,e){return window.console.log("moovefail: to",t,"from",e),!0},addcheck:function(t,e,o){return window.console.log("Add check",this,t,e,o),!0},onadd:function(t,e,o,n){window.console.log("On add",this,t,e,o,n)},onselectrow:function(t,e){window.console.log("onselectrow",this,t,e)},onmouseoverrow:function(t,e){window.console.log("onmouseoverrow",this,t,e)},ontogglefolder:function(t,e){window.console.log("ontogglefolder",this,t,e)},dropzone:{url:"http://www.torrentplease.com/dropzone.php"},dropzoneEvents:{},resolveIcon:function(t){return"folder"===t.kind?t.open?m("i.fa.fa-folder-open-o"," "):m("i.fa.fa-folder-o"," "):t.data.icon?m("i.fa."+t.data.icon," "):m("i.fa.fa-file ")},resolveToggle:function(t){var e=m("i.fa.fa-minus-square-o"," "),o=m("i.fa.fa-plus-square-o"," ");return"folder"===t.kind&&t.children.length>0?t.open?e:o:""},resolvePagination:function(t,e){return window.console.log("resolvePAgination: totalPages: ",t," currentPage: ",e),m("span","totalPages: "+t+" currentPage: "+e)},resolveUploadUrl:function(t){return window.console.log("resolveUploadUrl",this,t),"/upload"},resolveLazyloadUrl:function(t){return window.console.log("resolveLazyloadUrl",this,t),"http://localhost:63342/mGrid/demo/small.json"}},t),m.module(document.getElementById(l.options.divID),l)},l});